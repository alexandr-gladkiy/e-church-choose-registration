const axios = require('axios');

const API_BASE = 'http://localhost:3000/api';

async function testReactivation() {
  console.log('üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏...\n');

  try {
    // 1. –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    console.log('1Ô∏è‚É£ –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');
    const testUser = {
      full_name: '–¢–µ—Å—Ç–æ–≤—ã–π –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
      city: '–ú–æ—Å–∫–≤–∞',
      church_name: '–¢–µ—Å—Ç–æ–≤–∞—è –¶–µ—Ä–∫–æ–≤—å',
      phone: '+7 (999) 123-45-67',
      comments: '–¢–µ—Å—Ç–æ–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π',
      need_accommodation: true,
      telegram_id: 123456789,
      telegram_username: 'testuser'
    };

    const createResponse = await axios.post(`${API_BASE}/users`, testUser);
    console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω:', createResponse.data.user.id);
    const userId = createResponse.data.user.id;

    // 2. –û—Ç–º–µ–Ω—è–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
    console.log('\n2Ô∏è‚É£ –û—Ç–º–µ–Ω—è–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é...');
    await axios.post(`${API_BASE}/users/${userId}/cancel`);
    console.log('‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞');

    // 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–º–µ–Ω–µ–Ω
    console.log('\n3Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–º–µ–Ω—ã...');
    const checkResponse = await axios.get(`${API_BASE}/users?telegramId=${testUser.telegram_id}`);
    const cancelledUser = checkResponse.data[0];
    console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–º–µ–Ω–µ–Ω:', cancelledUser.cancelled_at ? '–î–∞' : '–ù–µ—Ç');

    // 4. –ü—ã—Ç–∞–µ–º—Å—è –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–æ
    console.log('\n4Ô∏è‚É£ –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–æ...');
    const reactivateResponse = await axios.post(`${API_BASE}/users`, {
      ...testUser,
      full_name: '–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –¢–µ—Å—Ç–æ–≤—ã–π –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
      phone: '+7 (999) 987-65-43'
    });

    console.log('‚úÖ –ü–æ–≤—Ç–æ—Ä–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!');
    console.log('üìã –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', {
      success: reactivateResponse.data.success,
      reactivated: reactivateResponse.data.reactivated,
      userId: reactivateResponse.data.user.id
    });

    // 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–Ω–æ–≤–∞ –∞–∫—Ç–∏–≤–µ–Ω
    console.log('\n5Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–Ω–æ–≤–∞ –∞–∫—Ç–∏–≤–µ–Ω...');
    const finalCheckResponse = await axios.get(`${API_BASE}/users?telegramId=${testUser.telegram_id}`);
    const reactivatedUser = finalCheckResponse.data[0];
    console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–∫—Ç–∏–≤–µ–Ω:', reactivatedUser.cancelled_at ? '–ù–µ—Ç' : '–î–∞');
    console.log('üìã –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:', {
      full_name: reactivatedUser.full_name,
      phone: reactivatedUser.phone,
      registration_date: reactivatedUser.registration_date
    });

    console.log('\nüéâ –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ! –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.');

  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –≤ —Ç–µ—Å—Ç–µ:', error.response?.data || error.message);
  }
}

testReactivation(); 